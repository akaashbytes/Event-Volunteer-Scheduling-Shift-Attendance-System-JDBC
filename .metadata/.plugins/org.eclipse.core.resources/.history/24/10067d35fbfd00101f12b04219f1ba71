package com.eventvol.service;

import java.sql.Connection;
import java.util.List;

import com.eventvol.bean.Assignment;
import com.eventvol.bean.Shift;
import com.eventvol.bean.Volunteer;
import com.eventvol.dao.AssignmentDAO;
import com.eventvol.dao.ShiftDAO;
import com.eventvol.dao.VolunteerDAO;
import com.eventvol.util.ValidationException;
import com.eventvol.util.OverlappingShiftAssignmentException;
import com.eventvol.util.ActiveAssignmentsExistException;
import com.eventvol.util.DBUtil;


public class EventService {

    VolunteerDAO volunteerDAO = new VolunteerDAO();
    ShiftDAO shiftDAO = new ShiftDAO();
    AssignmentDAO assignmentDAO = new AssignmentDAO();
    public Volunteer viewVolunteerDetails(String volunteerID)
            throws ValidationException {

        if (volunteerID == null || volunteerID.trim().isEmpty()) {
            throw new ValidationException();
        }

        return volunteerDAO.findVolunteer(volunteerID);
    }
    public List<Volunteer> viewAllVolunteers() {
        return volunteerDAO.viewAllVolunteers();
    }
    public boolean registerNewVolunteer(Volunteer volunteer)
            throws ValidationException {

        if (volunteer == null ||
            volunteer.getVolunteerID() == null ||
            volunteer.getFullName() == null ||
            volunteer.getPrimaryPhone() == null ||
            volunteer.getSkillCategory() == null) {

            throw new ValidationException();
        }
        if (volunteerDAO.findVolunteer(volunteer.getVolunteerID()) != null) {
            return false;
        }

        volunteer.setStatus("ACTIVE");
        return volunteerDAO.insertVolunteer(volunteer);
    }
    public Shift viewShiftDetails(int shiftID) {
        return shiftDAO.findShift(shiftID);
    }
    public List<Shift> viewAllShifts() {
        return shiftDAO.viewAllShifts();
    }
    public boolean createShift(Shift shift)
            throws ValidationException {

        if (shift == null ||
            shift.getShiftDate() == null ||
            shift.getStartTime() == null ||
            shift.getEndTime() == null ||
            shift.getLocation() == null ||
            shift.getRequiredHeadcount() <= 0) {

            throw new ValidationException();
        }

        return shiftDAO.insertShift(shift);
    }
    public boolean assignVolunteerToShift(
            String volunteerID,
            int shiftID,
            String role)
            throws ValidationException,
                   OverlappingShiftAssignmentException {

        Connection con = null;
        try {
            con = DBUtil.getDBConnection();
            con.setAutoCommit(false); // ðŸ”´ service controls transaction

            // validations
            Volunteer v = volunteerDAO.findVolunteer(volunteerID);
            Shift s = shiftDAO.findShift(shiftID);
            if (v == null || s == null) {
                return false;
            }

            Assignment a = new Assignment();
            a.setAssignmentID(assignmentDAO.generateAssignmentID());
            a.setVolunteerID(volunteerID);
            a.setShiftID(shiftID);
            a.setAssignedRole(role);
            a.setAttendanceStatus("PENDING");

            boolean inserted = assignmentDAO.insertAssignment(a);

            if (inserted) {
                con.commit();     // âœ… REQUIRED
                return true;
            } else {
                con.rollback();   // âœ… REQUIRED
                return false;
            }

        } catch (Exception e) {
            try {
                if (con != null) con.rollback();
            } catch (Exception ex) {
                ex.printStackTrace();
            }
            e.printStackTrace();
            return false;
        }
    }

    public boolean markAttendance(
            int assignmentID,
            String attendanceStatus,
            String checkinTime,
            String checkoutTime)
            throws ValidationException {

        if (assignmentID <= 0 ||
            (!"PRESENT".equalsIgnoreCase(attendanceStatus) &&
             !"ABSENT".equalsIgnoreCase(attendanceStatus))) {
            throw new ValidationException();
        }

        return assignmentDAO.updateAttendance(
                assignmentID,
                attendanceStatus,
                checkinTime,
                checkoutTime);
    }
    public boolean removeVolunteer(String volunteerID)
            throws ValidationException,
                   ActiveAssignmentsExistException {

        if (volunteerID == null || volunteerID.trim().isEmpty()) {
            throw new ValidationException();
        }

        List<Assignment> active =
                assignmentDAO.findActiveAssignmentsForVolunteer(volunteerID);

        if (active != null && !active.isEmpty()) {
            throw new ActiveAssignmentsExistException();
        }

        return volunteerDAO.deleteVolunteer(volunteerID);
    }
    public boolean removeShift(int shiftID)
            throws ValidationException,
                   ActiveAssignmentsExistException {

        if (shiftID <= 0) {
            throw new ValidationException();
        }

        List<Assignment> active =
                assignmentDAO.findActiveAssignmentsForShift(shiftID);

        if (active != null && !active.isEmpty()) {
            throw new ActiveAssignmentsExistException();
        }

        return shiftDAO.updateShiftStatus(shiftID, "CANCELLED");
    }
}
